import json
import sys

def get_vulnerability_details(vulnerability_data, artifact, matcher_source):
    """Extracts and formats details for a single vulnerability object."""
    
    # Extract version, name, and ID
    package_name = artifact.get("name", "N/A")
    version = artifact.get("version", "N/A")
    cve_id = vulnerability_data.get("id", "N/A")
    severity = vulnerability_data.get("severity", "").capitalize()

    # Determine Fix_State and Fix_Versions
    fix_data = vulnerability_data.get("fix", {})
    fix_state = fix_data.get("state", "").replace("not-fixed", "").replace("wont-fix", "")
    fix_versions = ", ".join(fix_data.get("versions", []))
    
    # URL (prioritizing the first URL in the list or the data source)
    urls = vulnerability_data.get("urls", [])
    url = urls[0] if urls else vulnerability_data.get("dataSource", "N/A")

    return {
        "Severity": severity,
        "CVE": cve_id,
        "Package": package_name,
        "Version": version,
        "Fix_State": fix_state,
        "Fix_Versions": fix_versions,
        "Source": matcher_source,
        "URL": url
    }

def parse_and_format_critical_high(file_path):
    """
    Reads a JSON vulnerability report, filters for Critical/High findings,
    and prints them in the specified format.
    """
    try:
        with open(file_path, 'r') as f:
            report_json = json.load(f)
    except (FileNotFoundError, json.JSONDecodeError) as e:
        print(f"Error processing file: {e}")
        return

    findings = report_json.get("matches", [])
    all_high_critical_findings = []
    
    for match in findings:
        vulnerability = match.get("vulnerability", {})
        related_vulnerabilities = match.get("relatedVulnerabilities", [])
        artifact = match.get("artifact", {})
        
        # Get the source matcher from the first match detail
        match_details = match.get("matchDetails", [{}])
        source = match_details[0].get("matcher", "N/A")
        
        # 1. Check the main vulnerability
        if vulnerability and vulnerability.get("severity", "").capitalize() in ["Critical", "High"]:
            all_high_critical_findings.append(
                get_vulnerability_details(vulnerability, artifact, source)
            )

        # 2. Check related vulnerabilities (which often hold NVD's higher severity)
        for related_vuln in related_vulnerabilities:
            if related_vuln.get("severity", "").capitalize() in ["Critical", "High"]:
                # Use the related vuln's data for severity and CVE, but the main artifact's context
                # NOTE: The artifact details (Package, Version, Fix_State) are usually tied 
                # to the main match, not the related vulnerability's external context.
                all_high_critical_findings.append(
                    get_vulnerability_details(related_vuln, artifact, source)
                )

    # Deduplicate findings based on CVE and Package to avoid redundant entries
    unique_findings = {}
    for finding in all_high_critical_findings:
        key = (finding["CVE"], finding["Package"])
        if key not in unique_findings:
            unique_findings[key] = finding
            
    final_findings = list(unique_findings.values())

    # --- Generate Formatted Output ---
    
    target_image = report_json.get("source", {}).get("target", {}).get("userInput", "N/A")
    
    separator = "=========================================================="
    print(separator)
    print(f"Critical/High Vulnerability Report for: {target_image}")
    print(f"({len(final_findings)} total findings)")
    print(separator)
    
    for finding in final_findings:
        print("{")
        print(f'  "Severity": "{finding["Severity"]}",')
        print(f'  "CVE": "{finding["CVE"]}",')
        print(f'  "Package": "{finding["Package"]}",')
        print(f'  "Version": "{finding["Version"]}",')
        print(f'  "Fix_State": "{finding["Fix_State"]}",')
        print(f'  "Fix_Versions": "{finding["Fix_Versions"]}",')
        print(f'  "Source": "{finding["Source"]}",')
        print(f'  "URL": "{finding["URL"]}"')
        print("}")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python parser.py <path_to_vulnerability_report.json>")
    else:
        file_path = sys.argv[1]
        parse_and_format_critical_high(file_path)